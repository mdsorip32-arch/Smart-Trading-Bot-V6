import telebot
import yfinance as yf
import pandas_ta as ta
import time
import os
import threading

# ‡ßß. ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶ì ‡¶Ü‡¶á‡¶°‡¶ø ‡¶ï‡¶æ‡¶®‡ßá‡¶ï‡¶∂‡¶®
TOKEN = os.getenv('TOKEN')
USER_ID = os.getenv('USER_ID')
bot = telebot.TeleBot(TOKEN)

# ‡ß®. ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡ßá‡¶ü ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü (BTC ‡¶¨‡¶æ ‡¶ó‡ßã‡¶≤‡ßç‡¶°)
SYMBOL = 'BTC-USD' 

def advanced_analysis():
    while True:
        try:
            # ‡ß©. ‡ßß ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡ßá‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
            df = yf.download(SYMBOL, interval='1m', period='1d', progress=False)
            if not df.empty:
                # ‡ß™. ‡¶∏‡¶¨ ‡¶∂‡¶ï‡ßç‡¶§‡¶ø‡¶∂‡¶æ‡¶≤‡ßÄ ‡¶á‡¶®‡ßç‡¶°‡¶ø‡¶ï‡ßá‡¶ü‡¶∞ ‡¶¶‡¶ø‡ßü‡ßá ‡¶è‡¶®‡¶æ‡¶≤‡¶æ‡¶á‡¶∏‡¶ø‡¶∏
                df['RSI'] = ta.rsi(df['Close'], length=14)
                df['EMA_20'] = ta.ema(df['Close'], length=20)
                df['EMA_50'] = ta.ema(df['Close'], length=50)
                
                last_row = df.iloc[-1]
                
                # ‡ß´. ‡¶ú‡¶ü‡¶ø‡¶≤ ‡¶è‡¶®‡¶æ‡¶≤‡¶æ‡¶á‡¶∏‡¶ø‡¶∏ ‡¶≤‡¶ú‡¶ø‡¶ï (‡¶≠‡ßÅ‡¶≤ ‡¶ï‡¶Æ‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
                # ‡¶Ø‡¶¶‡¶ø RSI ‡¶®‡¶ø‡¶ö‡ßá ‡¶•‡¶æ‡¶ï‡ßá ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶∏ EMA ‡¶è‡¶∞ ‡¶â‡¶™‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡ßá ‡¶§‡¶¨‡ßá‡¶á UP ‡¶∏‡¶ø‡¶ó‡¶®‡ßç‡¶Ø‡¶æ‡¶≤
                if last_row['RSI'] < 40 and last_row['Close'] > last_row['EMA_20']:
                    direction = "üöÄ ‡¶è‡¶®‡¶æ‡¶≤‡¶æ‡¶á‡¶∏‡¶ø‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤: **UP (‡¶â‡¶™‡¶∞‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá)** üü¢"
                # ‡¶Ø‡¶¶‡¶ø RSI ‡¶â‡¶™‡¶∞‡ßá ‡¶•‡¶æ‡¶ï‡ßá ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶∏ EMA ‡¶è‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá ‡¶•‡¶æ‡¶ï‡ßá ‡¶§‡¶¨‡ßá‡¶á DOWN ‡¶∏‡¶ø‡¶ó‡¶®‡ßç‡¶Ø‡¶æ‡¶≤
                elif last_row['RSI'] > 60 and last_row['Close'] < last_row['EMA_20']:
                    direction = "üìâ ‡¶è‡¶®‡¶æ‡¶≤‡¶æ‡¶á‡¶∏‡¶ø‡¶∏ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡ßá‡¶≤: **DOWN (‡¶®‡¶ø‡¶ö‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá)** üî¥"
                else:
                    direction = "‚è≥ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡ßá‡¶ü ‡¶è‡¶ñ‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶®‡¶æ, ‡¶è‡¶ï‡¶ü‡ßÅ ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§"

                # ‡ß¨. ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡ßß ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡ßá‡¶∞ ‡¶è‡¶≤‡¶æ‡¶∞‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
                msg = (
                    f"üìä **‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶≠‡¶æ‡¶®‡ßç‡¶∏‡¶° ‡ßß-‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶∏‡¶ø‡¶ó‡¶®‡ßç‡¶Ø‡¶æ‡¶≤**\n\n"
                    f"üéØ ‡¶Æ‡¶æ‡¶∞‡ßç‡¶ï‡ßá‡¶ü: {SYMBOL}\n"
                    f"{direction}\n"
                    f"üí∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡¶æ‡¶á‡¶∏: {round(last_row['Close'], 2)}"
                )
                bot.send_message(USER_ID, msg, parse_mode='Markdown')

            # ‡ß≠. ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡ßß ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶™‡¶∞‡¶™‡¶∞ ‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶æ‡¶ô‡ßç‡¶ó ‡¶è‡¶®‡¶æ‡¶≤‡¶æ‡¶á‡¶∏‡¶ø‡¶∏ ‡¶ï‡¶∞‡¶¨‡ßá
            time.sleep(60) 
        except Exception as e:
            time.sleep(10)

if __name__ == "__main__":
    bot.send_message(USER_ID, "üöÄ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡ßÅ‡¶≤ ‡¶è‡¶®‡¶æ‡¶≤‡¶æ‡¶á‡¶∏‡¶ø‡¶∏ ‡ßß-‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶ü‡ßç‡¶∞‡ßá‡¶°‡¶ø‡¶Ç ‡¶¨‡¶ü ‡¶è‡¶ñ‡¶® ‡¶∏‡¶ï‡ßç‡¶∞‡¶ø‡ßü!")
    advanced_analysis()
