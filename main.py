import telebot
import yfinance as yf
import pandas_ta as ta
import time
import os
import pytz
from datetime import datetime

# рзз. ржХрж╛ржирзЗржХрж╢ржи
TOKEN = os.getenv('TOKEN')
USER_ID = os.getenv('USER_ID')
bot = telebot.TeleBot(TOKEN)
SYMBOL = 'BTC-USD' 

# рзи. рж╕рзМржжрж┐ ржЖрж░ржм ржЯрж╛ржЗржоржЬрзЛржи (KSA)
SAUDI_TZ = pytz.timezone('Asia/Riyadh')

def get_saudi_time():
    return datetime.now(SAUDI_TZ).strftime('%I:%M:%S %p')

def start_ultra_precision():
    while True:
        try:
            # рзй. рж▓рж╛ржЗржн ржорж╛рж░рзНржХрзЗржЯ ржбрж╛ржЯрж╛ (рж╕рж░рж╛рж╕рж░рж┐ рзз ржорж┐ржирж┐ржЯрзЗрж░ ржХрзНржпрж╛ржирзНржбрзЗрж▓)
            ticker = yf.Ticker(SYMBOL)
            # рж╕рж░рж╛рж╕рж░рж┐ рзз ржжрж┐ржирзЗрж░ ржбрж╛ржЯрж╛ ржерзЗржХрзЗ рж╢рзЗрж╖ ржХрзНржпрж╛ржирзНржбрзЗрж▓ржЧрзБрж▓рзЛ ржмрж┐рж╢рзНрж▓рзЗрж╖ржг
            df = ticker.history(period="1d", interval="1m")
            
            if not df.empty and len(df) > 20:
                # рзк. ржПржбржнрж╛ржирзНрж╕ржб рж▓рж╛ржЗржн ржПржирж╛рж▓рж╛ржЗрж╕рж┐рж╕ (ржПржХ ржЪрзБрж▓ ржкрж░рж┐ржорж╛ржг ржПржжрж┐ржХ рж╕рзЗржжрж┐ржХ рж╣ржмрзЗ ржирж╛)
                df['RSI'] = ta.rsi(df['Close'], length=9) # ржирж┐ржЦрзБржБржд ржПржирзНржЯрзНрж░рж┐рж░ ржЬржирзНржп рзп ржкрж┐рж░рж┐рзЯржб
                df['EMA_9'] = ta.ema(df['Close'], length=9) # рж▓рж╛ржЗржн ржЯрзНрж░рзЗржирзНржб ржХржиржлрж╛рж░рзНржорзЗрж╢ржи
                
                last_row = df.iloc[-1]
                
                # рзл. рж╕рж┐ржЧржирзНржпрж╛рж▓ рж╕рж┐ржжрзНржзрж╛ржирзНржд (рж▓рж╛ржнрзЗрж░ рж╕ржорзНржнрж╛ржмржирж╛ ржмрзЗрж╢рж┐ рж░рж╛ржЦрж╛рж░ ржЬржирзНржп)
                # ржХрзНржпрж╛ржирзНржбрзЗрж▓ EMA ржПрж░ ржЙржкрж░рзЗ ржПржмржВ RSI рж╢ржХрзНрждрж┐ рж╕ржЮрзНржЪрзЯ ржХрж░рж▓рзЗ UP
                if last_row['Close'] > last_row['EMA_9'] and last_row['RSI'] < 60 and last_row['Close'] > last_row['Open']:
                    status = "ЁЯЯв **PREDICTION: UP** ЁЯЯв"
                    instruction = "ЁЯЪА ржорж╛рж░рзНржХрзЗржЯ рж╕рзНржЯрзНрж░ржВ! рзз ржорж┐ржирж┐ржЯрзЗрж░ ржЬржирзНржп UP ржЯрзНрж░рзЗржб ржирж┐ржиред"
                
                # ржХрзНржпрж╛ржирзНржбрзЗрж▓ EMA ржПрж░ ржирж┐ржЪрзЗ ржПржмржВ RSI ржжрзБрж░рзНржмрж▓ рж╣рж▓рзЗ DOWN
                elif last_row['Close'] < last_row['EMA_9'] and last_row['RSI'] > 40 and last_row['Close'] < last_row['Open']:
                    status = "ЁЯФ┤ **PREDICTION: DOWN** ЁЯФ┤"
                    instruction = "ЁЯУЙ ржорж╛рж░рзНржХрзЗржЯ ржжрзБрж░рзНржмрж▓! рзз ржорж┐ржирж┐ржЯрзЗрж░ ржЬржирзНржп DOWN ржЯрзНрж░рзЗржб ржирж┐ржиред"
                
                else:
                    # ржпржжрж┐ ржЯрзНрж░рзЗржирзНржб ржЕрж╕рзНржкрж╖рзНржЯ ржерж╛ржХрзЗ, рждржмрзЗ рзз рж╢рждрж╛ржВрж╢ рж▓рж╕ ржПрзЬрж╛рждрзЗ HOLD
                    status = "тП│ **HOLD / WAIT** тП│"
                    instruction = "тЪая╕П ржорж╛рж░рзНржХрзЗржЯ ржПржЦржи ржХржиржлрж┐ржЙржЬржб, ржПржЗ ржорж┐ржирж┐ржЯржЯрж┐ ржПрзЬрж┐рзЯрзЗ ржЪрж▓рзБржиред"

                # рзм. рж╕рж┐ржЧржирзНржпрж╛рж▓ ржорзЗрж╕рзЗржЬ
                msg = (
                    f"ЁЯОп **ULTRA-LIVE SIGNAL (1 MIN)**\n"
                    f"ЁЯХТ Time: {get_saudi_time()}\n"
                    f"ЁЯТ╣ Asset: {SYMBOL}\n\n"
                    f"ЁЯУв **Decision: {status}**\n\n"
                    f"ЁЯУЭ {instruction}\n"
                    f"ЁЯТ░ Live Price: {round(last_row['Close'], 2)}"
                )
                bot.send_message(USER_ID, msg, parse_mode='Markdown')

            # рзн. ржарж┐ржХ рзмрзж рж╕рзЗржХрзЗржирзНржб (рзз ржорж┐ржирж┐ржЯ) ржкрж░ ржкрж░ ржЖржкржбрзЗржЯ
            time.sleep(60) 
            
        except Exception as e:
            # ржПрж░рж░ рж╣рж▓рзЗ рззрзж рж╕рзЗржХрзЗржирзНржб ржкрж░ ржЖржмрж╛рж░ ржХрж╛ржирзЗржХрж╢ржи ржХрж░рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛
            time.sleep(10)

if __name__ == "__main__":
    bot.send_message(USER_ID, f"тЬЕ рж▓рж╛ржЗржн ржорж╛рж░рзНржХрзЗржЯ ржбрж╛ржЯрж╛ ржмржЯ рж╕ржХрзНрж░рж┐рзЯ!\nржПржЦржи ржерзЗржХрзЗ ржЖржкржирж┐ ржирж┐ржЦрзБржБржд рж╕рзМржжрж┐ ржЖрж░ржмрзЗрж░ рж╕ржорзЯрзЗ рж╕рж┐ржЧржирзНржпрж╛рж▓ ржкрж╛ржмрзЗржиред")
    start_ultra_precision()
